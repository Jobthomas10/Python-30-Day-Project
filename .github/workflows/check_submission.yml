name: Check Daily Submissions

on:
  issues:
    types: [labeled]
jobs:
  check-submissions:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Get the labels for the current issue from GitHub context
        id: get_day
        run: |
          # Get the labels from the GitHub context as a valid JSON array
          labels="${{ toJson(github.event.issue.labels) }}"
          
          # Debug: output the labels to verify if they are properly retrieved
          echo "Labels: $labels"
          
          # Extract the day number from the label in the format "Day-X"
          day_label=$(echo "$labels" | jq -r '.[] | select(.name | test("^Day-[0-9]+$")) | .name')
          
          # Extract the number after "Day-" from the label
          day_number=$(echo "$day_label" | sed -E 's/Day-([0-9]+)/\1/')
          
          # Output the day number to be used in the following steps
          echo "::set-output name=day::$day_number"

      - name: Check for each member's submission
        id: check_files
        run: |
          day_folder="Day-${{ steps.get_day.outputs.day }}"
          members=("joegeorge022" "JoeMartinRince" "Ganesh-Chandran005" "Jobthomas10")
          all_files_present=true

          # Check if all members have uploaded their file in the specified folder
          for member in "${members[@]}"; do
            if ! ls "${day_folder}" | grep -q "$member"; then
              all_files_present=false
              break
            fi
          done

          echo "::set-output name=all_files_present::$all_files_present"

      - name: Close issue if all files are present
        if: steps.check_files.outputs.all_files_present == 'true'
        uses: peter-evans/close-issue@v2
        with:
          issue-number: ${{ github.event.issue.number }}
          comment: "All members have uploaded their files for this task. Marking it complete. âœ…"
          state: closed
